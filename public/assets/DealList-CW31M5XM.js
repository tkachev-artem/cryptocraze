import{j as e}from"./vendor-query-xVwBccZt.js";import{r as t,b as s}from"./vendor-react-DaALiM5L.js";import{u as a,g as i,I as l,w as r,J as n,B as c,n as o,K as d,x as m,h as x,L as p}from"./trading-DauNLBUI.js";import{L as u}from"./index-3eMW2xY9.js";import"./vendor-redux-Bn24jW_n.js";import"./vendor-charts-ioXX35je.js";import"./vendor-socket-CUkmNz_4.js";const f=(e,t)=>{const s=e.replace("USDT","").replace("USD","");return t(`crypto.names.${s}`)||t("crypto.names.default")||s};function b(){const[d,m]=t.useState("active"),[x,f]=t.useState([]),[b,g]=t.useState(!0),[N,j]=t.useState(!1),[v,y]=t.useState(new Set),[w,S]=t.useState(0),k=s(),F=a(),{t:C}=i();t.useEffect(()=>{(async()=>{try{const e=await n.getUserDeals();f(e)}catch(e){}finally{g(!1)}})()},[]);const D=e=>{k(`/trade?edit=${e.id.toString()}`)},E=e=>{m(e),f(e=>e.map(e=>({...e,currentPrice:void 0,liveProfit:void 0}))),S(e=>e+1)},U=async e=>{try{y(t=>new Set(t).add(e));const t={dealId:e},s=await n.closeDeal(t),a=parseFloat(s.profit);F(p({profit:parseFloat(a.toFixed(2)),isProfit:a>=0}));const i=setInterval(()=>{document.querySelector('[data-modal="deal-info"]')||(clearInterval(i),j(!0),window.location.reload())},100)}catch(t){}finally{y(t=>{const s=new Set(t);return s.delete(e),s})}},P=t.useMemo(()=>x.filter(e=>"open"===e.status).map(e=>e.id),[x]),{profits:$,isConnected:T}=l(P);t.useEffect(()=>{P.length&&f(e=>e.map(e=>"open"===e.status&&e.id in $?{...e,profit:$[e.id].profit}:e))},[$,P]);const A=t.useMemo(()=>{const e=new Set;for(const t of x)"open"===t.status&&e.add(t.symbol);return Array.from(e)},[x]),{prices:I}=r(A),[L,B]=t.useState({});t.useEffect(()=>{const e=P.filter(e=>!(e in L));0!==e.length&&(async()=>{const t=await Promise.allSettled(e.map(async e=>{try{const t=await n.getDealCommission(e),s=Number.parseFloat(String(t.commission));if(Number.isFinite(s))return{id:e,commission:s}}catch{}return{id:e,commission:NaN}}));B(e=>{const s={...e};for(const a of t)"fulfilled"===a.status&&(s[a.value.id]=a.value.commission);return s})})()},[P,L]),t.useEffect(()=>{A.length&&f(e=>e.map(e=>{if("open"!==e.status)return e;if(e.id in $&&null!=$[e.id].profit)return e;const t=I[e.symbol.toUpperCase()];if(!(null==t?void 0:t.price))return e;const s=Number.parseFloat(String(e.openPrice)),a=Number.parseFloat(String(e.amount)),i=Number(e.multiplier),l=Number(t.price);if(!(Number.isFinite(s)&&Number.isFinite(a)&&Number.isFinite(i)&&Number.isFinite(l)))return e;const r=("up"===e.direction?(l-s)/s:(s-l)/s)*a*i,n=Number.isFinite(Number(e.commission))?Number(e.commission):L[e.id]||0;let c=Number.isFinite(n)?Number(n):NaN;if(!Number.isFinite(c)){c=5e-4*(a*i)}const o=(r-c).toFixed(2);return e.profit===o?e:{...e,profit:o}}))},[I,A,L,$]),t.useEffect(()=>{if("active"!==d)return;if(!P.length)return;const e=async()=>{try{const e=await n.getActiveDealsProfit();f(t=>t.map(t=>{const s=e.find(e=>e.dealId===t.id);return s?{...t,profit:s.profit}:t}))}catch(e){}};if(e(),T)return;const t=setInterval(()=>{e()},5e3);return()=>{clearInterval(t)}},[d,T,P]);const M=x.filter(e=>"active"===d?"open"===e.status:"closed"===e.status),q=x.filter(e=>"open"===e.status).length,O=x.filter(e=>"closed"===e.status).length;return b||N?e.jsx(u,{isLoading:!0}):e.jsxs("div",{className:"min-h-screen bg-white flex flex-col",children:[e.jsxs("div",{className:"flex items-center gap-1 px-2 py-4 bg-white",children:[e.jsx("button",{onClick:()=>{k(-1)},className:"flex items-center justify-center w-10 h-10 rounded-full hover:bg-gray-100",children:e.jsx("img",{src:"/top-menu/back.svg",alt:C("common.back"),className:"w-6 h-6"})}),e.jsx("span",{className:"text-xl font-bold text-black",children:C("nav.back")||C("common.back")})]}),e.jsxs("div",{className:"flex flex-col gap-2 px-4 py-3 bg-white",children:[e.jsxs("div",{className:"w-full flex bg-gray-100 rounded-[40px] p-1",children:[e.jsx("button",{onClick:()=>{E("active")},className:"w-full px-4 py-2.5 rounded-[20px] text-sm font-bold transition-all "+("active"===d?"bg-[#0C54EA] text-white":"text-black opacity-30"),children:C("deals.active")||"Активные"}),e.jsx("button",{onClick:()=>{E("closed")},className:"w-full px-4 py-2.5 rounded-[20px] text-sm font-bold transition-all "+("closed"===d?"bg-[#0C54EA] text-white":"text-black opacity-30"),children:C("deals.closed")||"Закрытые"})]}),e.jsx("div",{className:"text-left",children:e.jsx("span",{className:"text-sm text-black font-bold",children:"active"===d?`${C("deals.activeCount")||"Действующие"} (${String(q)})`:`${C("deals.closed")} (${String(O)})`})})]}),e.jsx("div",{className:"flex-1 px-4 pb-[calc(80px+env(safe-area-inset-bottom))] space-y-3",children:0===M.length?e.jsxs("div",{className:"flex flex-col items-center justify-center flex-1 text-black mt-10",children:[e.jsx("img",{src:"/deal/sleep-bear.svg",alt:"",className:"w-48 h-32 mb-6"}),e.jsx("p",{className:"text-2xl font-bold text-center mb-6",children:"active"===d?C("deals.noOpenOrders")||"У вас пока нет открытых ордеров":C("deals.noClosedTrades")||"У вас пока нет закрытых сделок"}),"active"===d&&e.jsx(c,{onClick:()=>{k("/trade")},className:"w-full px-6 py-3 bg-[#0C54EA] text-white font-bold text-base rounded-full hover:bg-blue-700",children:C("landing.getStarted")})]}):M.map(t=>e.jsx(h,{deal:t,closingDeals:v,onEdit:D,onClose:U},t.id))},`deals-${String(w)}`),e.jsx(o,{})]},w)}const h=({deal:t,closingDeals:s,onEdit:a,onClose:l})=>{const{t:r}=i(),n=d[t.symbol]||"",{iconUrl:c}=m(n);return e.jsxs("div",{className:"bg-white rounded-lg sm:rounded-xl border border-gray-200 overflow-hidden",children:[e.jsxs("div",{className:"flex justify-between items-center p-1.5 sm:p-2 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-1.5 sm:gap-2",children:[e.jsx("img",{src:c??(u=t.symbol,{BTC:"/trade/bitcoin.svg"}[u.replace("USDT","").replace("USD","").toUpperCase()]||"/trade/bitcoin.svg"),alt:f(t.symbol,r),className:"w-8 h-8 sm:w-10 sm:h-10"}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"flex flex-col items-start gap-0.5 sm:gap-1",children:[e.jsx("span",{className:"text-base sm:text-lg font-bold text-black",children:f(t.symbol,r)}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-[10px] sm:text-xs font-medium text-black uppercase",children:t.symbol.replace("USDT","/USD")}),e.jsx("div",{className:"w-3 h-3 sm:w-4 sm:h-4 "+("up"===t.direction?"text-green-500":"text-red-500"),children:e.jsx("img",{src:"up"===t.direction?"/deal/up.svg":"/deal/down.svg",alt:"up"===t.direction?r("trading.gain"):r("trading.loss"),className:"w-full h-full"})})]})]}),e.jsx("span",{className:"text-[10px] sm:text-xs text-black opacity-50",children:(p=t.openedAt,new Date(p).toLocaleDateString("ru-RU",{day:"2-digit",month:"2-digit",year:"2-digit",hour:"2-digit",minute:"2-digit"}))})]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-0.5 sm:gap-1",children:[e.jsx("div",{className:"flex items-center gap-1",children:e.jsx("span",{className:"text-lg sm:text-xl font-extrabold uppercase "+(t.profit&&parseFloat(t.profit)>=0?"text-green-500":"text-red-500"),children:(()=>{const e=t.profit?parseFloat(t.profit):NaN;if(!Number.isNaN(e)){return`${e>=0?"+":"-"}${x(Math.abs(e))}`}return x(0)})()})}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-[10px] sm:text-xs font-medium text-black",children:(o=t.amount,x(o))}),e.jsx("div",{className:"w-0.5 h-0.5 sm:w-1 sm:h-1 border border-black rounded-full"}),e.jsxs("span",{className:"text-[10px] sm:text-xs font-medium text-black",children:[t.multiplier,"x"]})]})]})]}),"open"===t.status&&e.jsxs("div",{className:"flex items-center justify-between p-2 sm:p-3",children:[e.jsxs("div",{className:"bg-[#F1F7FF] rounded-[20px] p-1 flex items-center gap-2",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"rounded-l-[999px] h-6 min-h-6 px-3 flex items-center justify-center "+(t.takeProfit?"bg-[#2EBD85]":"bg-black/30"),children:e.jsx("span",{className:"text-xs font-extrabold uppercase text-white",children:"TP"})}),e.jsx("div",{className:"rounded-r-[999px] h-6 min-h-6 px-3 flex items-center justify-center "+(t.stopLoss?"bg-[#F6465D]":"bg-black/30"),children:e.jsx("span",{className:"text-xs font-extrabold uppercase text-white",children:"SL"})})]}),e.jsxs("button",{onClick:()=>{a(t)},className:"flex items-center gap-1 px-2 py-1 bg-white border border-gray-200 rounded-[20px] shadow-sm","aria-label":r("deal.edit")||"Редактировать TP/SL",children:[e.jsx("img",{src:"/deal/edit-deal.svg",alt:r("deal.edit")||"Редактировать",className:"w-3 h-3"}),e.jsx("span",{className:"text-xs font-bold text-blue-600",children:r("deal.edit")})]})]}),e.jsx("button",{onClick:()=>{l(t.id)},disabled:s.has(t.id),className:"px-2 py-1.5 rounded-[40px] text-sm font-bold "+(s.has(t.id)?"bg-gray-400 text-white cursor-not-allowed":"bg-[#0C54EA] text-white hover:bg-blue-700"),children:s.has(t.id)?r("deal.closing")||"Закрытие...":r("deal.closeTrade")||"Закрыть"})]})]});var o,p,u};export{b as DealList};
